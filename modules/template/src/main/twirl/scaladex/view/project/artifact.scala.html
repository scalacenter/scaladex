@import scaladex.core.model._
@import scaladex.view.html.main
@import scaladex.core.model.web.ArtifactPageParams
@import scaladex.view.Formats
@import scaladex.view.html._

@(
    env: Env,
    user: Option[UserState],
    project: Project,
    artifact: Artifact,
    binaryVersions: Seq[BinaryVersion],
    params: ArtifactPageParams,
    directDeps: Seq[ArtifactDependency.Direct],
    reverseDeps: Seq[ArtifactDependency.Reverse],
    numberOfVersions: Long,
    lastProjectVersion: SemanticVersion
)
@main(env, title = project.repository.toString, user) {
  <main id="container-project">
    @headproject(env, user, project, numberOfVersions, "Artifacts", lastProjectVersion)
    <div class="container">
      <div class="row">
        <div class="col-md-8">
          <div class="content-project">
            <div class="artifact box" data-organization="@project.reference.organization" data-repository="@project.reference.repository">
              <div class="float-right">
                <form>
                  <select name="binary-version" class="selectpicker"
                  data-style="btn-primary" onchange="this.form.submit()">
                  @for((platform, binaryVersions) <- binaryVersions.groupBy(_.platform)) {
                    <optgroup label="@{platform.label}">
                      @for(binaryVersion <- binaryVersions.sortBy(_.language)(Language.ordering.reverse)) {
                        <option value="@binaryVersion.label"
                          @if(params.binaryVersion.contains(binaryVersion) || artifact.binaryVersion == binaryVersion) {selected}>
                          @binaryVersion
                        </option>
                      }
                    </optgroup>
                  }
                  </select>
                </form>
              </div>
              <h3>
                <a href="@artifactsUri(project.reference, artifact.artifactName, params.binaryVersion)">@artifact.artifactName</a>
                <span class="artifact-version">@artifact.version</span>
              </h3>
              <hr>
              @info("Group ID") { @artifact.groupId }
              @info("Artifact ID") { @artifact.artifactId }
              @info("Version") { @artifact.version }
              @info("Release Date") { @artifact.releaseDateFormat }
              @info("Licenses") {
                @for(license <- artifact.licenses) {
                <a href="@license.url.getOrElse("#")">@license.shortName</a>
                }
              }
              @if(artifact.resolver.isEmpty) {
                @info("Files") { <a href="@artifact.mavenReference.repoUrl">View all</a> }
              }
            </div>
            @installBox(project.settings.cliArtifacts)
          </div>
        </div>
        <div class="col-md-4 sidebar-project">
          @documentationBox
          @dependenciesBox
          @dependentsBox
        </div>
      </div>
    </div>
  </main>
}

@info(key: String)(value: Html) = {
  <div class="row">
    <div class="col-xs-5 col-sm-3">@key:</div>
    <div class="col-xs-7 col-sm-9">@value</div>
  </div>
}

@documentationLinks = @{ project.artifactDocumentation(artifact) }
@documentationBox = {
  @if(documentationLinks.nonEmpty) {
    <div class="documentation box">
      <h4>Documentation</h4>
      <ul>
        @for(doc <- documentationLinks){
          <li><a href="@doc.link" rel="nofollow">@doc.label</a></li>
        }
      </ul>
    </div>
  }
}

@dependenciesBox = {
  <div class="dependencies box">
    <h4>@Formats.plural(directDeps.size, "Dependency")</h4>
    <hr>
    <ul>
      @for(dep <- directDeps.sorted){
        <li>
          <div class="row">
            <div class="col-xs-9">
              <a href="@dep.url">@dep.groupIdAndName</a>
              @if(dep.artifactDep.scope.value != "compile") { 
                <span class="label label-default">@dep.artifactDep.scope</span>
              }
            </div>
            <div class="col-xs-3">@dep.version</div>
          </div>
        </li>
      }
      </ul>
  </div>
}

@sample = @{ArtifactDependency.Reverse.sample(reverseDeps, 100)}
@dependentsBox = {
  <div class="dependents box">
    <h4>@Formats.plural(reverseDeps.size, "Dependent")</h4>
    <hr>
    <ul>
      @for(dep <- sample){
        <li>
          <div class="row">
            <div class="col-xs-9">
              <a href="@dep.url">@dep.groupIdAndName</a>
              @if(dep.dependency.scope.value != "compile") {
                <span class="label label-default">@dep.dependency.scope</span>
              }
            </div>
            <div class="col-xs-3">@dep.version</div>
          </div>
        </li>
      }
      @if(reverseDeps.size > 100) {
        <p>and @{reverseDeps.size - 100} more</p>
      }
    </ul>
  </div>
}

@installBox(cliArtifacts: Set[Artifact.Name]) = {
  <div class="install">
    <ul class="nav nav-tabs nav-justified">
      @tabLink("sbt", "sbt", true)
      @tabLink("mill", "Mill")
      @if(cliArtifacts.contains(artifact.artifactName)) {
        @tabLink("coursier", "Coursier")
      }
      @tabLink("ammonite", "Ammonite")
      @tabLink("maven", "Maven")
      @tabLink("gradle", "Gradle")
    </ul>
    <div class="box tab-content">
      @tabPanel("sbt", artifact.sbtInstall, true) { }
      @tabPanel("mill", artifact.millInstall) {
        <a href="https://com-lihaoyi.github.io/mill">Mill build tool</a>
      }
      @if(cliArtifacts.contains(artifact.artifactName)) {
        @tabPanel("coursier", artifact.csLaunch) {
          <a href="https://get-coursier.io/docs/cli-overview">Coursier</a>
        }
      }
      @tabPanel("ammonite", artifact.ammInstall) {
        <a href="https://ammonite.io/#Ammonite-REPL">Ammonite REPL</a>
      }
      @tabPanel("maven", artifact.mavenInstall) { }
      @tabPanel("gradle", artifact.gradleInstall) { }
    </div>
  </div>
}

@tabLink(ref: String, title: String, active: Boolean = false) = {
  <li role="presentation" @if(active){ class="active" }>
    <a href="#@ref" aria-controls="@ref" role="tab" data-toggle="tab">@title</a>
  </li>
}

@tabPanel(ref: String, install: String, active: Boolean = false)(description: Html) = {
  <div role="tabpanel" class="tab-pane @if(active){ active }" id="@ref">
    <p>@description</p>
    <pre id="copy-@ref" class="copyable-incantation">@install</pre>
    <button class="btn btn-primary btn-copy pull-right" data-clipboard-target="copy-@ref">Copy</button>
  </div>
}
